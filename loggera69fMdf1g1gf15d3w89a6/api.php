<?php
/*
	$datasObject = '[{"test":"testoz_1"},{"test":"testoz_2"},{"test":"testoz_3"},{"test":"testoz_4"},{"test":"testoz_5"},{"test":"testoz_6"},{"test":"testoz_7"},{"test":"testoz_8"},{"test":"testoz_9"},{"test":"testoz_10"},{"test":"testoz_11"},{"test":"testoz_12"},{"test":"testoz_13"},{"test":"testoz_14"},{"test":"testoz_15"},{"test":"testoz_16"},{"test":"testoz_17"},{"test":"testoz_18"},{"test":"testoz_19"},{"test":"testoz_20"},{"test":"testoz_21"},{"test":"testoz_22"},{"test":"testoz_23"},{"test":"testoz_24"},{"test":"testoz_25"},{"test":"testoz_26"},{"test":"testoz_27"},{"test":"testoz_28"},{"test":"testoz_29"},{"test":"testoz_30"},{"test":"testoz_31"},{"test":"testoz_32"},{"test":"testoz_33"},{"test":"testoz_34"},{"test":"testoz_35"},{"test":"testoz_36"},{"test":"testoz_37"},{"test":"testoz_38"},{"test":"testoz_39"},{"test":"testoz_40"},{"test":"testoz_41"},{"test":"testoz_42"},{"test":"testoz_43"},{"test":"testoz_44"},{"test":"testoz_45"},{"test":"testoz_46"},{"test":"testoz_47"},{"test":"testoz_48"},{"test":"testoz_49"},{"test":"testoz_50"},{"test":"testoz_51"},{"test":"testoz_52"},{"test":"testoz_53"},{"test":"testoz_54"},{"test":"testoz_55"},{"test":"testoz_56"},{"test":"testoz_57"},{"test":"testoz_58"},{"test":"testoz_59"},{"test":"testoz_60"},{"test":"testoz_61"},{"test":"testoz_62"},{"test":"testoz_63"},{"test":"testoz_64"},{"test":"testoz_65"},{"test":"testoz_66"},{"test":"testoz_67"},{"test":"testoz_68"},{"test":"testoz_69"},{"test":"testoz_70"},{"test":"testoz_71"},{"test":"testoz_72"},{"test":"testoz_73"},{"test":"testoz_74"},{"test":"testoz_75"},{"test":"testoz_76"},{"test":"testoz_77"},{"test":"testoz_78"},{"test":"testoz_79"},{"test":"testoz_80"},{"test":"testoz_81"},{"test":"testoz_82"},{"test":"testoz_83"},{"test":"testoz_84"},{"test":"testoz_85"},{"test":"testoz_86"},{"test":"testoz_87"},{"test":"testoz_88"},{"test":"testoz_89"},{"test":"testoz_90"},{"test":"testoz_91"},{"test":"testoz_92"},{"test":"testoz_93"},{"test":"testoz_94"},{"test":"testoz_95"},{"test":"testoz_96"},{"test":"testoz_97"},{"test":"testoz_98"},{"test":"testoz_99"},{"test":"testoz_100"},{"test":"testoz_101"},{"test":"testoz_102"},{"test":"testoz_103"},{"test":"testoz_104"},{"test":"testoz_105"},{"test":"testoz_106"},{"test":"testoz_107"},{"test":"testoz_108"},{"test":"testoz_109"},{"test":"testoz_110"},{"test":"testoz_111"},{"test":"testoz_112"},{"test":"testoz_113"},{"test":"testoz_114"},{"test":"testoz_115"},{"test":"testoz_116"},{"test":"testoz_117"},{"test":"testoz_118"},{"test":"testoz_119"},{"test":"testoz_120"},{"test":"testoz_121"},{"test":"testoz_122"},{"test":"testoz_123"},{"test":"testoz_124"},{"test":"testoz_125"},{"test":"testoz_126"},{"test":"testoz_127"},{"test":"testoz_128"},{"test":"testoz_129"},{"test":"testoz_130"},{"test":"testoz_131"},{"test":"testoz_132"},{"test":"testoz_133"},{"test":"testoz_134"},{"test":"testoz_135"},{"test":"testoz_136"},{"test":"testoz_137"},{"test":"testoz_138"},{"test":"testoz_139"},{"test":"testoz_140"},{"test":"testoz_141"},{"test":"testoz_142"},{"test":"testoz_143"},{"test":"testoz_144"},{"test":"testoz_145"},{"test":"testoz_146"},{"test":"testoz_147"},{"test":"testoz_148"},{"test":"testoz_149"},{"test":"testoz_150"},{"test":"testoz_151"},{"test":"testoz_152"},{"test":"testoz_153"},{"test":"testoz_154"},{"test":"testoz_155"},{"test":"testoz_156"},{"test":"testoz_157"},{"test":"testoz_158"},{"test":"testoz_159"},{"test":"testoz_160"},{"test":"testoz_161"},{"test":"testoz_162"},{"test":"testoz_163"},{"test":"testoz_164"},{"test":"testoz_165"},{"test":"testoz_166"},{"test":"testoz_167"},{"test":"testoz_168"},{"test":"testoz_169"},{"test":"testoz_170"},{"test":"testoz_171"},{"test":"testoz_172"},{"test":"testoz_173"},{"test":"testoz_174"},{"test":"testoz_175"},{"test":"testoz_176"},{"test":"testoz_177"},{"test":"testoz_178"},{"test":"testoz_179"},{"test":"testoz_180"},{"test":"testoz_181"},{"test":"testoz_182"},{"test":"testoz_183"},{"test":"testoz_184"},{"test":"testoz_185"},{"test":"testoz_186"},{"test":"testoz_187"},{"test":"testoz_188"},{"test":"testoz_189"},{"test":"testoz_190"},{"test":"testoz_191"},{"test":"testoz_192"},{"test":"testoz_193"},{"test":"testoz_194"},{"test":"testoz_195"},{"test":"testoz_196"},{"test":"testoz_197"},{"test":"testoz_198"},{"test":"testoz_199"},{"test":"testoz_200"},{"test":"testoz_201"},{"test":"testoz_202"},{"test":"testoz_203"},{"test":"testoz_204"},{"test":"testoz_205"},{"test":"testoz_206"},{"test":"testoz_207"},{"test":"testoz_208"},{"test":"testoz_209"},{"test":"testoz_210"},{"test":"testoz_211"},{"test":"testoz_212"},{"test":"testoz_213"},{"test":"testoz_214"},{"test":"testoz_215"},{"test":"testoz_216"},{"test":"testoz_217"},{"test":"testoz_218"},{"test":"testoz_219"},{"test":"testoz_220"},{"test":"testoz_221"},{"test":"testoz_222"},{"test":"testoz_223"},{"test":"testoz_224"},{"test":"testoz_225"},{"test":"testoz_226"},{"test":"testoz_227"},{"test":"testoz_228"},{"test":"testoz_229"},{"test":"testoz_230"},{"test":"testoz_231"},{"test":"testoz_232"},{"test":"testoz_233"},{"test":"testoz_234"},{"test":"testoz_235"},{"test":"testoz_236"},{"test":"testoz_237"},{"test":"testoz_238"},{"test":"testoz_239"},{"test":"testoz_240"},{"test":"testoz_241"},{"test":"testoz_242"},{"test":"testoz_243"},{"test":"testoz_244"},{"test":"testoz_245"},{"test":"testoz_246"},{"test":"testoz_247"},{"test":"testoz_248"},{"test":"testoz_249"},{"test":"testoz_250"}]';
	$datasObject = json_decode($datasObject);
*/
	// 250 lenght of data

	$datasObject = array();
	$page = (isset($_POST['page']) AND is_numeric($_POST['page']) AND $_POST['page'] > 0) ? $_POST['page'] : 1;
	$count = (isset($_POST['count']) AND is_numeric($_POST['count']) AND $_POST['count'] > 0) ? $_POST['count'] : 1;
	$filter = (isset($_POST['filter']) AND !empty($_POST['filter'])) ? $_POST['filter'] : array();
	$sorting = (isset($_POST['sorting']) AND !empty($_POST['sorting'])) ? $_POST['sorting'] : null;
	$filter_save = $filter;
	$start = ($count * $page) - $count;

	if (isset($filter['Username'])) {
		$filter['AcctId'] = (int) $filter['Username'];
		unset($filter['Username']);
	}

	if (isset($filter['Character'])) {
		$filter['CharacterId'] = (int) $filter['Character'];
		unset($filter['Character']);
	}

	foreach ($filter as $key => $value)
	{
		if (is_numeric($value))
			$filter[$key] = (int)$value;
	}

	foreach ($sorting as $key => $value)
	{
		$ordered = ($value == 'desc') ? -1 : 1;
		if($key == 'Username') $sorting = array('label' => 'AcctId','order' => $ordered);
		elseif($key == 'Character') $sorting = array('label' => 'CharacterId','order' => $ordered);
		elseif($key != 'Date') $sorting = array('label' => $key,'order' => $ordered);
		// Date inclus
		else $sorting = array('label' => '_id','order' => $ordered);

		break;
	}

	$options = array("connectTimeoutMS" => 5000);
	$m = new MongoClient( 'mongodb://logger:jkNW39ky@10.10.1.6:27017/stump_log',$options);

	$database   = $m->stump_log;
	$collection = $database->characters_connections;


	$cursor = $collection->find($filter);
	if($sorting != null) $cursor = $cursor->sort(array($sorting['label'] => $sorting['order']));
	$cursor = $cursor->skip($start)->limit($count); //->sort(array('Date' => -1))


	$datasCount = $collection->find($filter)->count();

	foreach ($cursor as $onedoc)
	{
		$data = (object)array();
		$data->Date = $onedoc['Date'];
		$data->Username = $onedoc['AcctId'];
		$data->Character = $onedoc['CharacterId'];
		$data->IPAddress = $onedoc['IPAddress'];
		$data->Action = $onedoc['Action'];

		array_push($datasObject, $data);
	}

	$dataToReturn = array(
		'total' => $datasCount,
		'filter' => $filter_save,
		'list' => $datasObject
	);

	echo json_encode($dataToReturn);


?>